# Generated by Chef, do not edit

<%- site_dir = node[:skeleton][:site_dir] -%>
<%- log_dir = node[:skeleton][:log_dir] -%>
<%- server_name = node[:skeleton][:server_name] -%>
<%- ssl = node[:skeleton][:ssl] -%>

<%- if ssl -%>
# Redirect all HTTP traffic to HTTPS
server {
    server_name           <%= server_name %>;
    listen                80;
    return                301 https://<%= server_name %>$request_uri;
}
<%- end -%>


server {

    server_name           <%= server_name %>;
    listen                <%= ssl ? '443 ssl' : '80' =%>;

    <%- if ssl -%>
    ssl_certificate       <%= ssl[:cert] %>;
    ssl_certificate_key   <%= ssl[:key] %>;
    <%- end -%>

    root                  <%= site_dir %>;
    access_log            <%= log_dir %>/access.log json;
    error_log             <%= log_dir %>/error.log;

    <%- if node[:skeleton][:htpasswd] -%>
    auth_basic            "Restricted";
    auth_basic_user_file  "<%= site_dir %>/../.htpasswd";
    <%- end -%>

    location ~ /(\.|Vagrantfile|chef|protected) {
        # Protect code files
        return 444;
    }

    <%- if node[:skeleton][:blocked_keywords] -%>
    location ~* (<%= node[:skeleton][:blocked_keywords].join("|") %>) {
        return 444;
    }
    <%- end -%>

    location ~ \.(css|gif|jpeg|jpg|js|png)$ {
        # Serve the file if it exists
        expires 1w;
    }

    location ~ \.php$ {
        try_files         $uri = 404;
        include           fastcgi_params;
        fastcgi_pass      127.0.0.1:9000;
        fastcgi_index     index.php;
        fastcgi_param     SCRIPT_FILENAME $document_root$fastcgi_script_name;
    }

    location / {
        index             index.html index.php;
        try_files         $uri $uri/ /index.php?$args;
    }
}


<%- if node[:skeleton][:enable_check_servername] -%>
server {
    listen      80 default;
    server_name _;
    return      301 <%= ssl ? 'https' : 'http' %>://<%= server_name %>$1;
}
<%- end -%>
